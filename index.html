<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تأكيد البريد / إعادة تعيين كلمة المرور - علاء الدين</title>
  <style>
    body{font-family: system-ui, Roboto, 'Segoe UI', Tahoma, sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f6f7fb;margin:0}
    .card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 18px rgba(20,30,60,0.08);width:100%;max-width:460px}
    h1{font-size:20px;margin:0 0 12px}
    p{color:#444;margin:0 0 18px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type="password"], input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e3e6ef;margin-bottom:12px;font-size:14px}
    button{width:100%;padding:12px;border-radius:10px;border:0;background:#0b69ff;color:white;font-weight:600;cursor:pointer}
    .muted{color:#777;font-size:13px}
    .success{background:#e6ffef;border-left:4px solid #28a745;padding:10px;border-radius:6px;margin-bottom:12px}
    .error{background:#fff4f4;border-left:4px solid #e04848;padding:10px;border-radius:6px;margin-bottom:12px}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <div class="card" role="main">
    <h1 id="title">جاري التحضير…</h1>
    <div id="notice" class="muted small">سيتم عرض تعليمات التأكيد أو إعادة التعيين هنا.</div>

    <div id="form-container" style="display:none;margin-top:12px">
      <label for="password">كلمة المرور الجديدة</label>
      <input id="password" type="password" placeholder="أدخل كلمة المرور الجديدة" autocomplete="new-password" />

      <label for="password2">تأكيد كلمة المرور</label>
      <input id="password2" type="password" placeholder="أعد كتابة كلمة المرور" autocomplete="new-password" />

      <button id="submit">تعيين كلمة المرور</button>
    </div>

    <div id="messages" style="margin-top:12px"></div>

    <p class="muted small" style="margin-top:14px">إذا ظهرت مشكلة: تأكد أن الرابط يحتوي على معامل <code>?code=...</code> وأنك تستخدم نهاية خدمة (Edge Function أو سيرفر) لمعالجة الكود بأمان.</p>
  </div>

  <script>
    // -------------------------
    // إعدادات (غيّرها إلى endpoint الخاص بك)
    // هذا الملف هو صفحة ثابتة (يمكن رفعها على GitHub Pages). لكنه لا ينفذ تغييرات على كلمات المرور مباشرة
    // لأن تغيير كلمة مرور بناءً على رمز تأكيد يتطلب مفتاح خدمة آمن (service_role) — لذلك يجب أن ترسل الكود
    // إلى Edge Function أو سيرفر خلفي يقوم بالتواصل مع Supabase بأمان.
    // ضع هنا رابط الـ Edge Function أو endpoint الذي سيستقبل { code, password }.
    const RESET_ENDPOINT = 'https://your-edge-function-or-server.example.com/reset-password';

    // -------------------------
    // مساعدة: الحصول على معامل الكود من الـ URL
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const code = getQueryParam('code');
    const titleEl = document.getElementById('title');
    const noticeEl = document.getElementById('notice');
    const formContainer = document.getElementById('form-container');
    const messages = document.getElementById('messages');

    function showMessage(text, type='info'){
      messages.innerHTML = '';
      const div = document.createElement('div');
      div.className = (type === 'success') ? 'success' : (type === 'error') ? 'error' : 'muted';
      div.textContent = text;
      messages.appendChild(div);
    }

    if (!code) {
      titleEl.textContent = 'رمز التأكيد غير موجود';
      noticeEl.textContent = 'الرابط يجب أن يحتوي على معامل "code"، مثال: ?code=172b60bf-accd-49cc-afc3-0e4347fabb47';
      // يمكنك إظهار حقل لإدخال البريد إذا أردت إرسال طلب جديد لإعادة التعيين
    } else {
      titleEl.textContent = 'تأكيد البريد أو إعادة تعيين كلمة المرور';
      noticeEl.textContent = 'تم العثور على رمز. اختر كلمة مرور جديدة لإكمال العملية.';
      formContainer.style.display = 'block';
    }

    // تنفيذ النداء إلى endpoint الخلفي
    document.getElementById('submit').addEventListener('click', async () => {
      const pw = document.getElementById('password').value.trim();
      const pw2 = document.getElementById('password2').value.trim();

      if (!pw || !pw2) return showMessage('كِلا الحقلين مطلوبان.', 'error');
      if (pw.length < 6) return showMessage('يجب أن تكون كلمة المرور 6 أحرف أو أكثر.', 'error');
      if (pw !== pw2) return showMessage('كلمتا المرور غير متطابقتين.', 'error');

      showMessage('جاري معالجة الطلب...');

      try {
        const res = await fetch(RESET_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code, password: pw })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || 'خطأ في الخادم');
        }

        const data = await res.json();
        // من المفيد أن يعيد endpoint حقل success أو message
        if (data && (data.success || res.status === 200)){
          showMessage(data.message || 'تم تغيير كلمة المرور بنجاح — يمكنك الآن تسجيل الدخول.', 'success');
          formContainer.style.display = 'none';
        } else {
          throw new Error(data.message || 'لم يتم تغيير كلمة المرور');
        }
      } catch (err) {
        console.error(err);
        showMessage('فشل التعيين: ' + (err.message || err), 'error');
      }
    });

    // -------------------------
    // ملاحظة للمطور: مثال عن edge function بسيط (Node) للتعامل مع Supabase 
    // (ضع هذا في سيرفرك أو كـ Edge Function، لا تضع service_role في الكود للعميل)
    /*
    // مثال مبسّط (Node/Express) — لا تنسَ حماية المسار ومعدل الطلبات
    const express = require('express');
    const fetch = require('node-fetch');
    const app = express();
    app.use(express.json());
    app.post('/reset-password', async (req, res) => {
      const { code, password } = req.body;
      if (!code || !password) return res.status(400).json({ success:false, message:'المعاملات ناقصة' });

      // استدعاء Supabase Admin API (تحتاج service_role key) — مثال عبر REST
      const SUPABASE_URL = process.env.SUPABASE_URL;
      const SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY; // احفظه في متغير بيئة

      const r = await fetch(`${SUPABASE_URL}/auth/v1/verify`, {
        method:'POST',
        headers:{ 'apikey': SERVICE_ROLE_KEY, 'Content-Type':'application/json' },
        body: JSON.stringify({ type:'recovery', token: code, password })
      });
      const body = await r.json();
      if (r.ok) return res.json({ success:true, message:'تم التعيين' });
      return res.status(400).json({ success:false, message: body?.error || 'خطأ من Supabase' });
    });
    */

  </script>
</body>
</html>